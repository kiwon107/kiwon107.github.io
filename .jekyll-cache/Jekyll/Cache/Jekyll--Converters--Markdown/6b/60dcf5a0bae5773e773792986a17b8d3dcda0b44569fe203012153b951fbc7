I"¯|<p>ë³¸ í¬ìŠ¤íŒ…ì€ â€œí­ê·„ë¸Œë¡œì˜ 3ë¶„ ë”¥ëŸ¬ë‹, íŒŒì´í† ì¹˜ë§›â€ ì±… ë‚´ìš©ì„ ê¸°ë°˜ìœ¼ë¡œ ì‘ì„±ë˜ì—ˆìŠµë‹ˆë‹¤.
ì˜ëª»ëœ ë‚´ìš©ì´ ìˆì„ ê²½ìš° ì§€ì í•´ ì£¼ì‹œë©´ ê°ì‚¬ë“œë¦¬ê² ìŠµë‹ˆë‹¤.</p>

<h2 id="8-1-resnet-ì†Œê°œ">8-1. ResNet ì†Œê°œ</h2>
<p class="align-center">ResNet(Residual Network) ëª¨ë¸ì€ CNNì„ ì‘ìš©í•œ ëª¨ë¸ì´ë‹¤. ì´ë¯¸ì§€ ì²œë§Œ ì¥ì„ í•™ìŠµí•˜ì—¬ 15ë§Œ ì¥ìœ¼ë¡œ ì¸ì‹ë¥ ì„ ê²¨ë£¨ëŠ” ì´ë¯¸ì§€ë„· ëŒ€íšŒì—ì„œ 2015ë…„ë„ ìš°ìŠ¹í•œ ëª¨ë¸. ì‹ ê²½ë§ì„ ê¹Šê²Œ ìŒ“ìœ¼ë©´ ì˜¤íˆë ¤ ì„±ëŠ¥ì´ ë‚˜ë¹ ì§€ëŠ” ë¬¸ì œë¥¼ í•´ê²°í•˜ëŠ” ë°©ë²•ìœ¼ë¡œ ì œì‹œí–ˆë‹¤. ì»¨ë²Œë£¨ì…˜ì¸µì˜ ì¶œë ¥ì— ì „ì˜ ì „ ê³„ì¸µì— ì“°ì˜€ë˜ ì…ë ¥ì„ ë”í•˜ì—¬ íŠ¹ì§•ì´ ìœ ì‹¤ë˜ì§€ ì•Šë„ë¡ í•˜ì˜€ë‹¤(ê·¸ë¦¼ 8-1).
<img src="/assets/images/deeplearningpyt/8-1.png" alt="ê·¸ë¦¼ 8-1. ì½”ë“œ ê²°ê³¼" /></p>
<p>ê·¸ë¦¼ 8-1. ì½”ë“œ ê²°ê³¼</p>

<h2 id="8-2-cifar-10-ë°ì´í„°ì…‹">8-2. CIFAR-10 ë°ì´í„°ì…‹</h2>
<p>CIFAR-10 ë°ì´í„°ì…‹ì„ ì‚¬ìš©í•˜ê² ë‹¤. ì´ë¯¸ì§€ë„· ë°ì´í„°ì…‹ì€ ë§¤ìš° ë°©ëŒ€í•˜ê³  ë¼ì´ì„ ìŠ¤ ë¬¸ì œë„ ìˆì–´ í† ì¹˜ë¹„ì „ì— ê¸°ë³¸ ìˆ˜ë¡ë¼ìˆì§€ ì•Šì•„ ì§ì ‘ ë°›ì•„ì•¼ í•œë‹¤. CIFAR-10 ë°ì´í„°ì…‹ì€ 32 x 32 í¬ê¸°ì˜ ì´ë¯¸ì§€ 6ë§Œê°œë¥¼ í¬í•¨í•˜ê³  ìˆê³ , ìë™ì°¨, ìƒˆ, ê³ ì–‘ì´, ì‚¬ìŠ´ ë“± 10ê°€ì§€ ë¶„ë¥˜ê°€ ì¡´ì¬í•œë‹¤. CIFAR-10 ë°ì´í„°ì…‹ì€ ì»¬ëŸ¬ ì´ë¯¸ì§€ë“¤ì„ í¬í•¨í•˜ê³  ìˆëŠ”ë°, ì»¬ëŸ¬ ì´ë¯¸ì§€ í”½ì…€ê°’ì€ ëª‡ ê°€ì§€ ì±„ë„ë“¤ë¡œ êµ¬ì„±ëœë‹¤. ì±„ë„ì€ ì´ë¯¸ì§€ì˜ ìƒ‰ìƒ êµ¬ì„±ìš”ì†Œë¥¼ ê°€ë¦¬í‚¨ë‹¤. ë¹¨ê°•, ì´ˆë¡, íŒŒë‘ ì„¸ ì¢…ë¥˜ì˜ ê´‘ì›ì„ í˜¼í•©í•˜ì—¬ ëª¨ë“  ìƒ‰ì„ í‘œí˜„í•œë‹¤. ì˜¤ëŠ˜ë‚  ê°€ì¥ ë„ë¦¬ ì“°ì´ëŠ” 24ë¹„íŠ¸ ì»¬ëŸ¬ ì´ë¯¸ì§€ëŠ” R, G, B ê°ê°ì— 8ë¹„íŠ¸ì”© ìƒ‰ìƒê°’ì„ ê°€ì§€ëŠ” 3ê°€ì§€ ì±„ë„ì„ ì‚¬ìš©í•œë‹¤.</p>
<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="kn">import</span> <span class="nn">torch</span>
<span class="kn">import</span> <span class="nn">torch.nn</span> <span class="k">as</span> <span class="n">nn</span>
<span class="kn">import</span> <span class="nn">torch.optim</span> <span class="k">as</span> <span class="n">optim</span>
<span class="kn">import</span> <span class="nn">torch.nn.functional</span> <span class="k">as</span> <span class="n">F</span>
<span class="kn">from</span> <span class="nn">torchvision</span> <span class="kn">import</span> <span class="n">transforms</span><span class="p">,</span> <span class="n">datasets</span><span class="p">,</span> <span class="n">models</span>

<span class="n">USE_CUDA</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">cuda</span><span class="p">.</span><span class="n">is_available</span><span class="p">()</span>
<span class="n">DEVICE</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">device</span><span class="p">(</span><span class="s">"cuda"</span> <span class="k">if</span> <span class="n">USE_CUDA</span> <span class="k">else</span> <span class="s">"cpu"</span><span class="p">)</span>

<span class="n">EPOCHS</span> <span class="o">=</span> <span class="mi">300</span>
<span class="n">BATCH_SIZE</span> <span class="o">-</span> <span class="mi">128</span>

<span class="n">train_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="s">'./.data'</span><span class="p">,</span>
                  <span class="n">train</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">download</span><span class="o">=</span><span class="bp">True</span><span class="p">,</span>
                  <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
                  <span class="n">transforms</span><span class="p">.</span><span class="n">RandomCrop</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">),</span>
                  <span class="n">transforms</span><span class="p">.</span><span class="n">RandomHorizontalFlip</span><span class="p">(),</span>
                  <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                  <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                                       <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))])),</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>

<span class="n">test_loader</span> <span class="o">=</span> <span class="n">torch</span><span class="p">.</span><span class="n">utils</span><span class="p">.</span><span class="n">data</span><span class="p">.</span><span class="n">DataLoader</span><span class="p">(</span>
    <span class="n">datasets</span><span class="p">.</span><span class="n">CIFAR10</span><span class="p">(</span><span class="s">'./.data'</span><span class="p">,</span>
                  <span class="n">train</span><span class="o">=</span><span class="bp">False</span><span class="p">,</span>
                  <span class="n">transform</span><span class="o">=</span><span class="n">transforms</span><span class="p">.</span><span class="n">Compose</span><span class="p">([</span>
                    <span class="n">transforms</span><span class="p">.</span><span class="n">ToTensor</span><span class="p">(),</span>
                    <span class="n">transforms</span><span class="p">.</span><span class="n">Normalize</span><span class="p">((</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">),</span>
                                         <span class="p">(</span><span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">,</span> <span class="mf">0.5</span><span class="p">))]))</span>
    <span class="n">batch_size</span><span class="o">=</span><span class="n">BATCH_SIZE</span><span class="p">,</span> <span class="n">shuffle</span><span class="o">=</span><span class="bp">True</span><span class="p">)</span>
</code></pre></div></div>

<h2 id="8-3-cnnì„-ê¹Šê²Œ-ìŒ“ëŠ”-ë°©ë²•">8-3. CNNì„ ê¹Šê²Œ ìŒ“ëŠ” ë°©ë²•</h2>
<p class="align-center">ì¸ê³µ ì‹ ê²½ë§ì„ ì—¬ëŸ¬ ê°œ ê²¹ì¹œë‹¤ê³  í•™ìŠµ ì„±ëŠ¥ì´ ì¢‹ì•„ì§€ì§„ ì•ŠëŠ”ë‹¤. ì—¬ëŸ¬ ë‹¨ê³„ ì‹ ê²½ë§ì„ ê±°ì¹˜ë©° ìµœì´ˆ ì…ë ¥ ì´ë¯¸ì§€ì— ëŒ€í•œ ì •ë³´ê°€ ì†Œì‹¤ë˜ê¸° ë•Œë¬¸ì´ë‹¤.<br />
ResNetì˜ í•µì‹¬ì€ ë„¤íŠ¸ì›Œí¬ë¥¼ ì‘ì€ ë¸”ë¡ì¸ Residual ë¸”ë¡ìœ¼ë¡œ ë‚˜ëˆ„ì—ˆë‹¤ëŠ” ê²ƒì´ë‹¤.
<img src="/assets/images/deeplearningpyt/8-2.png" alt="ê·¸ë¦¼ 8-2. ì½”ë“œ ê²°ê³¼" /></p>
<p>ê·¸ë¦¼ 8-2. ì½”ë“œ ê²°ê³¼</p>

<p>Rasidual ë¸”ë¡ì˜ ì¶œë ¥ì— ì…ë ¥ì´ì—ˆë˜ xë¥¼ ë”í•˜ì—¬ ëª¨ë¸ì„ í›¨ì”¬ ê¹Šê²Œ ì„¤ê³„í•  ìˆ˜ ìˆë„ë¡ í•œë‹¤. ì¦‰, ì…ë ¥ê³¼ ì¶œë ¥ì˜ ê´€ê³„ë¥¼ ë°”ë¡œ í•™ìŠµí•˜ëŠ” ê²ƒë³´ë‹¤, ì…ë ¥ê³¼ ì¶œë ¥ì˜ ì°¨ì´ë¥¼ ë”°ë¡œ í•™ìŠµí•˜ëŠ”ê²Œ ì„±ëŠ¥ì´ ì¢‹ë‹¤ëŠ” ê²ƒì´ë‹¤.<br />
ì‹ ê²½ë§ì„ ê¹Šê²Œ í• ìˆ˜ë¡ ì¢‹ì€ ì´ìœ ëŠ” ë¬¸ì œë¥¼ ë” ì‘ì€ ë‹¨ìœ„ë¡œ ë¶„í•´í•˜ì—¬ í•™ìŠµ íš¨ìœ¨ì´ ì¢‹ì•„ì§€ê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ëŸ¬ë‚˜ ê³„ì¸µì´ ê¹Šì–´ì§ì— ë”°ë¼ ì‹ í˜¸ì˜ ê°•ë„ê°€ ê°ì†Œí•˜ê²Œ ëœë‹¤. ResNetì€ ì…ë ¥ ë°ì´í„°ë¥¼ ëª‡ ê³„ì¸µì”© ê±´ë„ˆë›°ì–´ ì¶œë ¥ì— ë”í•¨ìœ¼ë¡œì¨ ì´ í˜„ìƒì„ ì™„í™”í•´ì¤€ë‹¤.<br />
Residual ë¸”ë¡ì„ BasicBlock ì´ë¼ëŠ” ìƒˆë¡œìš´ íŒŒì´í† ì¹˜ ëª¨ë“ˆë¡œ ì •ì˜í•´ì„œ ì‚¬ìš©í•´ë³´ì. ì°¸ê³ ë¡œ BasicBlock ì½”ë“œì—ëŠ” <code class="language-plaintext highlighter-rouge">nn.BatchNorm2d</code>ë¼ëŠ” ë…€ì„ì´ ìˆë‹¤. <strong>ë°°ì¹˜ ì •ê·œí™”(Batch Normalization)</strong>ì„ ìˆ˜í–‰í•˜ëŠ” ê³„ì¸µì¸ë°, í•™ìŠµ ì¤‘ ê° ê³„ì¸µì— ë“¤ì–´ê°€ëŠ” ì…ë ¥ì„ í‰ê· ê³¼ ë¶„ì‚°ìœ¼ë¡œ ì •ê·œí™”í•˜ì—¬, í•™ìŠµë¥ ì„ ë†’ê²Œ ì¡ì„ ë•Œ ê¸°ìš¸ê¸°ê°€ ì†Œì‹¤ë˜ê±°ë‚˜ ë°œì‚°ë˜ëŠ” ì¦ìƒì„ ì˜ˆë°©ì‹œì¼œì£¼ëŠ” ë°©ë²•ì´ë‹¤. ìì²´ì ìœ¼ë¡œ ì •ê·œí™”ë¥¼ ìˆ˜í–‰í•´ ë“œë¡­ì•„ì›ƒê³¼ ê°™ì€ íš¨ê³¼ë¥¼ ë‚¸ë‹¤. ì°¨ì´ë¼ë©´ ë“œë¡­ì•„ì›ƒì€ ì¼ë¶€ ë°ì´í„°ë¥¼ ë°°ì œí•˜ëŠ” ë°˜ë©´, ë°°ì¹˜ ì •ê·œí™”ëŠ” ì‹ ê²½ë§ ë‚´ë¶€ ë°ì´í„°ì— ì§ì ‘ ì˜í–¥ì„ ì¤€ë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">BasicBlock</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">in_planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">BasicBlock</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">bn2</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>

        <span class="bp">self</span><span class="p">.</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">()</span>  <span class="c1"># ì—¬ëŸ¬ nn.Moduleì„ í•˜ë‚˜ì˜ ëª¨ë“ˆë¡œ ë¬¶ëŠ” ì—­í• . ê° ë ˆì´ì–´ë¥¼ ë°ì´í„°ê°€ ìˆœì°¨ì ìœ¼ë¡œ ì§€ë‚˜ê°ˆ ë•Œ ì‚¬ìš©í•˜ë©´ ì½”ë“œ ê°„ê²°í•˜ê²Œ ë§Œë“¤ ìˆ˜ ìˆìŒ.
</span>        <span class="k">if</span> <span class="n">stride</span> <span class="o">!=</span> <span class="mi">1</span> <span class="ow">or</span> <span class="n">in_planes</span> <span class="o">!=</span> <span class="n">planes</span><span class="p">:</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">shortcut</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span>
                <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="n">stride</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">),</span>  <span class="c1"># ì¦í­í•˜ëŠ” ì—­í• !
</span>                <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="n">planes</span><span class="p">)</span>
            <span class="p">)</span>
        
    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bn1</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">bn2</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv2</span><span class="p">(</span><span class="n">out</span><span class="p">))</span>
        <span class="n">out</span> <span class="o">+=</span> <span class="bp">self</span><span class="p">.</span><span class="n">shortcut</span><span class="p">(</span><span class="n">x</span><span class="p">)</span>  <span class="c1"># ì´ì „ ì…ë ¥ì„ ì¤‘ê°„ì¸µì— ë”í•´ì£¼ì–´ ì´ë¯¸ì§€ ë§¥ë½ ë³´ì¡´ë˜ë„ë¡ í•¨!
</span>        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>
<p>ì´ì œ ëª¨ë¸ì„ ì •ì˜í•´ë³´ì. ì´ë¯¸ì§€ë¥¼ ë°›ì•„ ì»¨ë³¼ë£¨ì…˜ê³¼ ë°°ì¹˜ì •ê·œí™” ì¸µì„ ê±°ì¹œ í›„, ì—¬ëŸ¬ BasicBlock ì¸µì„ í†µê³¼í•˜ê³  í‰ê·  í’€ë§ê³¼ ì‹ ê²½ë§ì„ ê±°ì³ ì˜ˆì¸¡ì„ ì¶œë ¥í•˜ë„ë¡ í•˜ì.<br />
BasicBlock í´ë˜ìŠ¤ëŠ” <code class="language-plaintext highlighter-rouge">self._make_layer()</code> í•¨ìˆ˜ë¥¼ í†µí•´ í•˜ë‚˜ì˜ ëª¨ë“ˆë¡œ ê°ì²´í™”í•˜ì—¬ ResNet ëª¨ë¸ì˜ ì£¼ìš” ì¸µì„ ì´ë£¨ë„ë¡ í•  ê²ƒì´ë‹¤.</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="k">class</span> <span class="nc">ResNet</span><span class="p">(</span><span class="n">nn</span><span class="p">.</span><span class="n">Module</span><span class="p">):</span>
    <span class="k">def</span> <span class="nf">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">num_classes</span><span class="o">=</span><span class="mi">10</span><span class="p">):</span>
        <span class="nb">super</span><span class="p">(</span><span class="n">ResNet</span><span class="p">,</span> <span class="bp">self</span><span class="p">).</span><span class="n">__init__</span><span class="p">()</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">in_planes</span> <span class="o">=</span> <span class="mi">16</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">conv1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Conv2d</span><span class="p">(</span><span class="mi">3</span><span class="p">,</span> <span class="mi">16</span><span class="p">,</span> <span class="n">kernel_size</span><span class="o">=</span><span class="mi">3</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">padding</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">bias</span><span class="o">=</span><span class="bp">False</span><span class="p">)</span>  <span class="c1"># RGB ì±„ë„ 3ê°œë¥¼ 16ê°œë¡œ ë§Œë“¬
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">bn1</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">BatchNorm2d</span><span class="p">(</span><span class="mi">16</span><span class="p">)</span>
        <span class="bp">self</span><span class="p">.</span><span class="n">layer1</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="mi">16</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>  <span class="c1"># 32 x 32 x 16
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">layer2</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="mi">32</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 32 x 16 x 16
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">layer3</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">_make_layer</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="n">stride</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>  <span class="c1"># 64 x 8 x 8
</span>        <span class="bp">self</span><span class="p">.</span><span class="n">linear</span> <span class="o">=</span> <span class="n">nn</span><span class="p">.</span><span class="n">Linear</span><span class="p">(</span><span class="mi">64</span><span class="p">,</span> <span class="n">num_classes</span><span class="p">)</span>  <span class="c1"># ì›ì†Œì˜ ê°œìˆ˜ 64ê°œë¡œ ë§Œë“  í›„, 64ê°œ ì…ë ¥ ë°›ì•„ ë ˆì´ë¸” ë§ˆë‹¤ ì˜ˆì¸¡ê°’ ë‚´ê²Œë¨
</span>
    <span class="k">def</span> <span class="nf">_make_layer</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">num_blocks</span><span class="p">,</span> <span class="n">stride</span><span class="p">):</span>
        <span class="n">strides</span> <span class="o">=</span> <span class="p">[</span><span class="n">stride</span><span class="p">]</span> <span class="o">+</span> <span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="p">(</span><span class="n">num_blocks</span><span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">layers</span><span class="o">=</span><span class="p">[]</span>
        <span class="k">for</span> <span class="n">stride</span> <span class="ow">in</span> <span class="n">strides</span><span class="p">:</span>  <span class="c1"># 2ë²ˆ ë“¤ì–´ê°!
</span>            <span class="n">layers</span><span class="p">.</span><span class="n">append</span><span class="p">(</span><span class="n">BasicBlock</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">in_planes</span><span class="p">,</span> <span class="n">planes</span><span class="p">,</span> <span class="n">stride</span><span class="p">))</span>
            <span class="bp">self</span><span class="p">.</span><span class="n">in_planes</span> <span class="o">=</span> <span class="n">planes</span>
        <span class="k">return</span> <span class="n">nn</span><span class="p">.</span><span class="n">Sequential</span><span class="p">(</span><span class="o">*</span><span class="n">layers</span><span class="p">)</span>

    <span class="k">def</span> <span class="nf">forward</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">x</span><span class="p">):</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">relu</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">bn1</span><span class="p">(</span><span class="bp">self</span><span class="p">.</span><span class="n">conv1</span><span class="p">(</span><span class="n">x</span><span class="p">)))</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">layer1</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">layer2</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">layer3</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">avg_pool2d</span><span class="p">(</span><span class="n">out</span><span class="p">,</span> <span class="mi">8</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="n">out</span><span class="p">.</span><span class="n">view</span><span class="p">(</span><span class="n">out</span><span class="p">.</span><span class="n">size</span><span class="p">(</span><span class="mi">0</span><span class="p">),</span> <span class="o">-</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">out</span> <span class="o">=</span> <span class="bp">self</span><span class="p">.</span><span class="n">linear</span><span class="p">(</span><span class="n">out</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">out</span>
</code></pre></div></div>

<p>ëª¨ë¸ì„ ì •ì˜í–ˆë‹¤ë©´ ì‚¬ìš©ë²•ì€ ê°™ë‹¤. ì—¬ê¸°ì—ì„œëŠ” í•™ìŠµë¥  ê°ì†Œ ê¸°ë²•ì„ ì‚¬ìš©í•œë‹¤. í•™ìŠµë¥  ê°ì†ŒëŠ” í•™ìŠµì´ ì§„í–‰í•˜ë©´ì„œ ìµœì í™” í•¨ìˆ˜ì˜ í•™ìŠµë¥ ì„ ì ì  ë‚®ì¶°ì„œ ë” ì •êµí•˜ê²Œ ìµœì í™”í•œë‹¤. íŒŒì´í† ì¹˜ ë‚´ë¶€ì˜ <code class="language-plaintext highlighter-rouge">optim.lr_scheduler.StepLR</code>ë„êµ¬ë¥¼ ì‚¬ìš©í•˜ì—¬ ì ìš©ê°€ëŠ¥í•˜ë‹¤!</p>

<div class="language-python highlighter-rouge"><div class="highlight"><pre class="highlight"><code><span class="n">model</span> <span class="o">=</span> <span class="n">ResNet</span><span class="p">().</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
<span class="n">optimizer</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">SGD</span><span class="p">(</span><span class="n">model</span><span class="p">.</span><span class="n">parameters</span><span class="p">(),</span> <span class="n">lr</span><span class="o">=</span><span class="mf">0.1</span><span class="p">,</span> <span class="n">momentum</span><span class="o">=</span><span class="mf">0.9</span><span class="p">,</span> <span class="n">weight_decay</span><span class="o">=</span><span class="mf">0.0005</span><span class="p">)</span>
<span class="n">scheduler</span> <span class="o">=</span> <span class="n">optim</span><span class="p">.</span><span class="n">lr_scheduler</span><span class="p">.</span><span class="n">StepLR</span><span class="p">(</span><span class="n">optimizer</span><span class="p">,</span> <span class="n">step_size</span><span class="o">=</span><span class="mi">50</span><span class="p">,</span> <span class="n">gamma</span><span class="o">=</span><span class="mf">0.1</span><span class="p">)</span>

<span class="k">def</span> <span class="nf">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimzer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">):</span>
    <span class="n">model</span><span class="p">.</span><span class="n">train</span><span class="p">()</span>
    <span class="k">for</span> <span class="n">batch_idx</span><span class="p">,</span> <span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">train_loader</span><span class="p">):</span>
        <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">target</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">zero_grad</span><span class="p">()</span>
        <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>
        <span class="n">loss</span> <span class="o">=</span> <span class="n">F</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">)</span>
        <span class="n">loss</span><span class="p">.</span><span class="n">backward</span><span class="p">()</span>
        <span class="n">optimizer</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>

<span class="k">def</span> <span class="nf">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">):</span>
    <span class="n">model</span><span class="p">.</span><span class="nb">eval</span><span class="p">()</span>
    <span class="n">test_loss</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">correct</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">with</span> <span class="n">torch</span><span class="p">.</span><span class="n">no_grad</span><span class="p">():</span>
        <span class="k">for</span> <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="ow">in</span> <span class="n">test_loader</span><span class="p">:</span>
            <span class="n">data</span><span class="p">,</span> <span class="n">target</span> <span class="o">=</span> <span class="n">data</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">),</span> <span class="n">target</span><span class="p">.</span><span class="n">to</span><span class="p">(</span><span class="n">DEVICE</span><span class="p">)</span>
            <span class="n">output</span> <span class="o">=</span> <span class="n">model</span><span class="p">(</span><span class="n">data</span><span class="p">)</span>

            <span class="n">test_loss</span> <span class="o">+=</span> <span class="n">F</span><span class="p">.</span><span class="n">cross_entropy</span><span class="p">(</span><span class="n">output</span><span class="p">,</span> <span class="n">target</span><span class="p">,</span> <span class="n">reduction</span><span class="o">=</span><span class="s">'sum'</span><span class="p">).</span><span class="n">item</span><span class="p">()</span>
            <span class="n">pred</span> <span class="o">=</span> <span class="n">output</span><span class="p">.</span><span class="nb">max</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdim</span><span class="o">=</span><span class="bp">True</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">correct</span> <span class="o">+=</span> <span class="n">pred</span><span class="p">.</span><span class="n">eq</span><span class="p">(</span><span class="n">target</span><span class="p">.</span><span class="n">view_as</span><span class="p">(</span><span class="n">pred</span><span class="p">)).</span><span class="nb">sum</span><span class="p">().</span><span class="n">item</span><span class="p">()</span>
        
        <span class="n">test_loss</span> <span class="o">/=</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="n">test_accuracy</span> <span class="o">=</span> <span class="mf">100.</span> <span class="o">*</span> <span class="n">correct</span> <span class="o">/</span> <span class="nb">len</span><span class="p">(</span><span class="n">test_loader</span><span class="p">.</span><span class="n">dataset</span><span class="p">)</span>
        <span class="k">return</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_accuracy</span>

<span class="k">for</span> <span class="n">epoch</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">EPOCHS</span><span class="o">+</span><span class="mi">1</span><span class="p">):</span>
    <span class="n">scheduler</span><span class="p">.</span><span class="n">step</span><span class="p">()</span>
    <span class="n">train</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">train_loader</span><span class="p">,</span> <span class="n">optimizer</span><span class="p">,</span> <span class="n">epoch</span><span class="p">)</span>
    <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_accuracy</span> <span class="o">=</span> <span class="n">evaluate</span><span class="p">(</span><span class="n">model</span><span class="p">,</span> <span class="n">test_loader</span><span class="p">)</span>

    <span class="k">print</span><span class="p">(</span><span class="s">'[{}] Test Loss: {:.4f}, Accuracy: {:.2f}%'</span><span class="p">.</span><span class="nb">format</span><span class="p">(</span><span class="n">epoch</span><span class="p">,</span> <span class="n">test_loss</span><span class="p">,</span> <span class="n">test_accuracy</span><span class="p">))</span>
</code></pre></div></div>
:ET